事发经过：
       生产环境Mongo数据膨胀很快，需要使用分片集群扩容。
       切换为集群后，发现大量报错。通过日志定位到mongo执行upsert操作出现的报错。

根本原因：
         在 MongoDB 分片集群中，当您执行 upsert 操作（特别是针对单个文档的更新，例如 updateOne 或 findAndModify，或者显式设置 multi: false 的 update 操作）时，如果查询条件中不包含分片键（或复合分片键的前缀），会抛出错误

报错原因：
1/查询路由到所有分片 (Scatter/Gather)：当查询条件不包含分片键时，mongos 查询路由器无法确定目标文档可能位于哪个分片上。为了找到匹配的文档，mongos 必须将该查询广播（scatter）到集群中的所有分片。

2/违反单文档更新原则：在所有分片上执行查询后，如果多个分片都找到了与查询条件相匹配的文档，并且都尝试执行 upsert 操作，这就会与您设置的 {multi: false}（或 updateOne、findAndModify 的默认单文档更新行为）相违背。系统无法在不引入不一致或不确定性的情况下，原子性地保证只更新/插入一个文档。

3/抛出错误以维护一致性：为了避免这种潜在的数据不一致和行为不确定性，MongoDB 会选择抛出错误，强制操作失败。这确保了在没有分片键作为精确路由依据的情况下，不会发生违反单文档更新语义的情况。
      
