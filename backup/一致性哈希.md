一致性哈希（Consistent Hashing）是一种特殊的哈希算法，它主要用于分布式缓存系统（如 Redis、Memcached）或分布式数据库的分片，以解决​**节点（服务器）数量变化时，数据映射关系的剧烈变化问题**​。

### 一、 一致性哈希的原理

传统的哈希分片方法通常使用取模运算：`hash(key) % N`（N 为节点数）。这种方法的缺陷在于，一旦节点数 N 发生变化（增加或删除节点），几乎**所有**数据都需要重新计算哈希并迁移，导致缓存大量失效或系统剧烈抖动。

一致性哈希通过引入一个\*\*哈希环（Hash Ring）\*\*来解决这个问题：

#### 1. 构建哈希环

* **环空间：** 首先定义一个 **\$2^{32}\$** 或更大的整数空间，并将其首尾相连，形成一个圆环，即​**哈希环**​。
* **节点映射：**
  * 对每一个\*\*物理节点（服务器）\*\*的标识（如 IP 地址或名称）进行哈希计算，将结果值映射到环上的某个位置。

#### 2. 数据映射与查找

* **数据映射：**
  * 对每一个\*\*数据键（Key）\*\*进行哈希计算，也将结果值映射到环上的某个位置。
* **查找规则：**
  * 从数据 Key 的映射位置出发，​**沿着哈希环顺时针查找**​，遇到的**第一个节点**就是该 Key 应该存储的节点。

### 二、 解决节点变化的问题（核心优势）

一致性哈希的关键价值在于其优雅地处理了节点增减：

| **场景**    | **传统取模方法 (hash(key) % N)**                                                | **一致性哈希**                                                                                   |
| ------------------- | --------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **新增节点 N+1** | 几乎所有 Key 的哈希结果`... % N`都会改变，导致**大部分数据**需要重新映射和迁移。 | 只有新节点和它**逆时针方向的第一个旧节点**之间的数据需要迁移到新节点上。影响范围极小。                |
| **删除节点 N-1** | 几乎所有 Key 的哈希结果都会改变。                                                     | 原本由被删除节点负责的数据，会**顺时针**转移给它**下一个**节点负责。影响范围仅限于被删除节点的数据。 |

### 三、 虚拟节点（Virtual Nodes）

虽然一致性哈希减少了数据迁移，但如果节点数量较少，节点在环上的分布可能不均匀，容易导致​**数据倾斜**​（某些节点承担了大部分数据）。

为了解决这个问题，引入了​**虚拟节点（Virtual Nodes）**​：

1. **映射策略：** 不再直接将物理节点映射到环上，而是为每个**物理节点**创建多个​**虚拟节点（副本）**​。
   * 例如：将 Node A 映射为 **\$A\\\_1, A\\\_2, A\\\_3, \\dots, A\\\_k\$** 等多个虚拟节点。
2. **分布优化：** 将所有虚拟节点均匀地映射到哈希环上。
3. **查找：** 数据 Key 仍然顺时针找到环上的第一个虚拟节点。该虚拟节点会内部映射回它的​**真实物理节点**​（Node A）。

**效果：** 虚拟节点数量越多，节点在环上的分布就越均匀，数据分布也就越平衡，同时还能进一步降低节点增减时的数据迁移量。

### 四、 总结

| **特性** | **描述**                                                                                     |
| ---------------- | ---------------------------------------------------------------------------------------------------- |
| **作用**      | 解决分布式系统中，节点增减时导致大量数据失效或迁移的问题。                                         |
| **核心**      | 将节点和数据映射到**哈希环**上，并采用**顺时针查找**的规则。                                     |
| **优势**      | 节点变化时，只需重新映射**\$\\text{K} / \\text{N}\$**的数据（K 为 Key 总数），而不是几乎全部数据。 |
| **优化**      | 使用**虚拟节点**来提高数据在环上的分布均匀性，避免数据倾斜。                                      |
